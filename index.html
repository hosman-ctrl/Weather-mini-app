<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherFlow</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ========== TELEGRAM THEME VARIABLES ========== */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f1f1;
            --tg-theme-header-bg-color: #ffffff;
            --tg-theme-accent-text-color: #2481cc;
            --tg-theme-section-bg-color: #f8f8f8;
            --tg-theme-section-header-text-color: #6d6d72;
            --tg-theme-subtitle-text-color: #6d6d72;
            --tg-theme-destructive-text-color: #ff3b30;
            
            /* iOS Weather App Colors */
            --clear-day: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            --clear-night: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --cloudy: linear-gradient(135deg, #757f9a 0%, #d7dde8 100%);
            --rainy: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
            --snowy: linear-gradient(135deg, #e6dada 0%, #9890e3 100%);
            --stormy: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            --foggy: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
            
            /* iOS-like shadows */
            --shadow-light: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-medium: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-heavy: 0 10px 25px rgba(0,0,0,0.1);
            
            /* Animation limits */
            --max-clouds: 3;
            --max-rain-drops: 15;
            --max-snow-flakes: 10;
        }

        /* ========== BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0;
            position: relative;
            min-height: 100vh;
        }

        /* ========== MINIMAL ENVIRONMENT ANIMATIONS ========== */
        .environment-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        /* Optimized Cloud Animation (Max 3 clouds) */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            filter: blur(8px);
            animation: float 60s linear infinite;
            opacity: 0.4;
            will-change: transform;
        }

        .cloud::before {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 60%;
            height: 60%;
            top: -20px;
            left: 10px;
            filter: blur(5px);
        }

        /* Optimized Rain Animation (Max 15 drops) */
        .rain-drop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 1px;
            animation: rain-fall 1s linear infinite;
            opacity: 0.6;
            will-change: transform;
        }

        /* Optimized Snow Animation (Max 10 flakes) */
        .snow-flake {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            filter: blur(0.5px);
            animation: snow-fall 3s linear infinite;
            opacity: 0.8;
            will-change: transform;
        }

        /* Sun/Moon with reduced animation */
        .sun-moon {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            top: 20px;
            right: 20px;
            z-index: 2;
            transition: transform 0.5s ease;
            will-change: transform;
        }

        .sun-moon.day {
            background: radial-gradient(circle at 30% 30%, #FFD700, #FF8C00);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
        }

        .sun-moon.night {
            background: radial-gradient(circle at 30% 30%, #E0E0E0, #A0A0A0);
            box-shadow: 0 0 30px rgba(224, 224, 224, 0.2);
        }

        /* Wind lines - minimal */
        .wind-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: wind-flow 20s linear infinite;
            opacity: 0.3;
            will-change: transform;
        }

        /* Fog overlay - static with opacity only */
        .fog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            transition: opacity 2s ease;
        }

        /* ========== ANIMATION KEYFRAMES ========== */
        @keyframes float {
            0% { transform: translateX(-100px) translateY(0); }
            100% { transform: translateX(calc(100vw + 100px)) translateY(0); }
        }

        @keyframes rain-fall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        @keyframes snow-fall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        @keyframes wind-flow {
            0% { transform: translateX(-100px); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateX(100vw); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* ========== LOCATION SELECTION SCREEN ========== */
        .location-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--tg-theme-bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .location-header {
            text-align: center;
            margin-bottom: 40px;
            max-width: 300px;
        }

        .location-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .location-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color);
        }

        .location-subtitle {
            font-size: 16px;
            color: var(--tg-theme-hint-color);
            line-height: 1.5;
            margin-bottom: 40px;
        }

        .location-options {
            width: 100%;
            max-width: 300px;
        }

        .location-option {
            display: flex;
            align-items: center;
            padding: 18px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            width: 100%;
            text-align: left;
            color: var(--tg-theme-text-color);
            font-size: 17px;
        }

        .location-option:hover, .location-option:active {
            background: var(--tg-theme-section-bg-color);
            transform: translateY(-1px);
        }

        .location-option .icon {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        .location-option .text {
            flex: 1;
        }

        .location-option .subtext {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-top: 2px;
        }

        .manual-search {
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color);
            border: none;
            border-radius: 14px;
            font-size: 16px;
            color: var(--tg-theme-text-color);
            margin-bottom: 12px;
        }

        .search-input:focus {
            outline: none;
            background: var(--tg-theme-section-bg-color);
        }

        .search-results {
            background: var(--tg-theme-bg-color);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result {
            padding: 14px 16px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
            cursor: pointer;
            font-size: 16px;
        }

        .search-result:hover {
            background: var(--tg-theme-secondary-bg-color);
        }

        .search-result .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-top: 2px;
        }

        /* ========== MAIN WEATHER APP ========== */
        .weather-app {
            display: none;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
            min-height: 100vh;
        }

        /* iOS Weather Header Style */
        .weather-header {
            padding: 60px 20px 30px;
            text-align: center;
            position: relative;
        }

        .location-name {
            font-size: 34px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .location-time {
            font-size: 18px;
            color: var(--tg-theme-hint-color);
            font-weight: 500;
            margin-bottom: 30px;
        }

        .temperature {
            font-size: 96px;
            font-weight: 100;
            letter-spacing: -3px;
            margin: 10px 0;
            line-height: 1;
        }

        .temperature::after {
            content: '¬∞';
            font-size: 80px;
            vertical-align: top;
            margin-left: -12px;
        }

        .weather-condition {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 30px;
            text-transform: capitalize;
        }

        .hi-low {
            font-size: 20px;
            font-weight: 600;
            color: var(--tg-theme-subtitle-text-color);
        }

        /* iOS-style Detail Cards */
        .detail-cards {
            padding: 0 20px 20px;
        }

        .detail-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            animation: scaleIn 0.3s ease;
            backdrop-filter: blur(20px);
            background: rgba(var(--card-bg-rgb), 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-subtitle-text-color);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .grid-item {
            text-align: center;
        }

        .grid-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .grid-value {
            font-size: 28px;
            font-weight: 600;
            line-height: 1;
        }

        .grid-unit {
            font-size: 16px;
            color: var(--tg-theme-hint-color);
            margin-left: 2px;
        }

        /* Forecast Section */
        .forecast-section {
            padding: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color);
        }

        .hourly-forecast {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            gap: 20px;
            scrollbar-width: none;
        }

        .hourly-forecast::-webkit-scrollbar {
            display: none;
        }

        .hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .hour-time {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-subtitle-text-color);
        }

        .hour-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
        }

        .hour-temp {
            font-size: 20px;
            font-weight: 600;
        }

        /* Air Quality & UV Index */
        .aqi-section {
            padding: 20px;
        }

        .aqi-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
        }

        .aqi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .aqi-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-subtitle-text-color);
        }

        .aqi-value {
            font-size: 32px;
            font-weight: 700;
        }

        .aqi-description {
            font-size: 15px;
            color: var(--tg-theme-hint-color);
            margin-top: 4px;
        }

        .aqi-bar {
            height: 4px;
            background: var(--tg-theme-section-bg-color);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .aqi-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 1s ease;
        }

        /* Sunrise/Sunset */
        .sun-times {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            margin: 0 20px 20px;
        }

        .sun-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sun-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .sun-time {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sun-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color);
            border-top: 1px solid var(--tg-theme-secondary-bg-color);
            display: flex;
            padding: 10px 20px;
            max-width: 500px;
            margin: 0 auto;
            z-index: 100;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            background: none;
            border: none;
            color: var(--tg-theme-hint-color);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-item.active {
            color: var(--tg-theme-button-color);
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Loading State */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--tg-theme-bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--tg-theme-secondary-bg-color);
            border-top-color: var(--tg-theme-button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 16px;
            color: var(--tg-theme-hint-color);
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 375px) {
            .temperature {
                font-size: 80px;
            }
            
            .location-name {
                font-size: 28px;
            }
            
            .weather-condition {
                font-size: 18px;
            }
        }

        @media (min-width: 768px) {
            .container {
                border-radius: 20px;
                overflow: hidden;
                box-shadow: var(--shadow-heavy);
                min-height: 90vh;
                margin: 5vh auto;
            }
            
            .tab-bar {
                border-radius: 0 0 20px 20px;
            }
        }

        /* ========== UTILITY CLASSES ========== */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .fade-in {
            opacity: 1;
            pointer-events: all;
            transition: opacity 0.3s ease;
        }

        /* Smooth scrolling for iOS */
        * {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <!-- Environment Animations (Minimal) -->
    <div class="environment-layer" id="environment"></div>
    <div class="fog-overlay" id="fogOverlay"></div>

    <!-- Loading Screen -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">Loading WeatherFlow...</div>
    </div>

    <!-- Location Selection Screen -->
    <div class="location-screen" id="locationScreen">
        <div class="location-header">
            <div class="location-icon">üå§Ô∏è</div>
            <h1 class="location-title">WeatherFlow</h1>
            <p class="location-subtitle">Get accurate weather forecasts with minimal animations for better performance</p>
        </div>
        
        <div class="location-options">
            <button class="location-option" id="useTelegramLocation">
                <span class="icon">üìç</span>
                <div class="text">
                    <div>Use Your Location</div>
                    <div class="subtext">Most accurate & energy efficient</div>
                </div>
            </button>
            
            <button class="location-option" id="useDefaultLocation">
                <span class="icon">üèôÔ∏è</span>
                <div class="text">
                    <div>New York, USA</div>
                    <div class="subtext">Default fallback location</div>
                </div>
            </button>
        </div>
        
        <div class="manual-search">
            <input type="text" class="search-input" id="searchInput" placeholder="Search city or coordinates...">
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Main Weather App -->
    <div class="container">
        <div class="weather-app" id="weatherApp">
            <!-- Weather Header -->
            <div class="weather-header" id="weatherHeader">
                <div class="location-name" id="locationName">--</div>
                <div class="location-time" id="locationTime">--:--</div>
                <div class="temperature" id="temperature">--</div>
                <div class="weather-condition" id="weatherCondition">--</div>
                <div class="hi-low" id="hiLow">H: --¬∞ L: --¬∞</div>
            </div>

            <!-- Detail Cards -->
            <div class="detail-cards">
                <div class="detail-card">
                    <div class="card-header">
                        <span>FEELS LIKE</span>
                        <span id="feelsLikeValue">--¬∞</span>
                    </div>
                    <div class="card-grid">
                        <div class="grid-item">
                            <div class="grid-label">Humidity</div>
                            <div class="grid-value"><span id="humidityValue">--</span><span class="grid-unit">%</span></div>
                        </div>
                        <div class="grid-item">
                            <div class="grid-label">Wind</div>
                            <div class="grid-value"><span id="windValue">--</span><span class="grid-unit">km/h</span></div>
                        </div>
                        <div class="grid-item">
                            <div class="grid-label">Pressure</div>
                            <div class="grid-value"><span id="pressureValue">--</span><span class="grid-unit">hPa</span></div>
                        </div>
                        <div class="grid-item">
                            <div class="grid-label">Visibility</div>
                            <div class="grid-value"><span id="visibilityValue">--</span><span class="grid-unit">km</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hourly Forecast -->
            <div class="forecast-section">
                <div class="section-title">HOURLY FORECAST</div>
                <div class="hourly-forecast" id="hourlyForecast">
                    <!-- Hourly items will be added here -->
                </div>
            </div>

            <!-- Air Quality & UV -->
            <div class="aqi-section">
                <div class="aqi-card">
                    <div class="aqi-header">
                        <div class="aqi-title">AIR QUALITY</div>
                        <div class="aqi-value" id="aqiValue">--</div>
                    </div>
                    <div class="aqi-description" id="aqiDescription">--</div>
                    <div class="aqi-bar">
                        <div class="aqi-fill" id="aqiBar" style="width: 0%; background: #00e676;"></div>
                    </div>
                </div>
                
                <div class="aqi-card">
                    <div class="aqi-header">
                        <div class="aqi-title">UV INDEX</div>
                        <div class="aqi-value" id="uvValue">--</div>
                    </div>
                    <div class="aqi-description" id="uvDescription">--</div>
                    <div class="aqi-bar">
                        <div class="aqi-fill" id="uvBar" style="width: 0%; background: #ff9800;"></div>
                    </div>
                </div>
            </div>

            <!-- Sunrise/Sunset -->
            <div class="sun-times">
                <div class="sun-item">
                    <div class="sun-icon">üåÖ</div>
                    <div class="sun-time" id="sunriseTime">--:--</div>
                    <div class="sun-label">Sunrise</div>
                </div>
                <div class="sun-item">
                    <div class="sun-icon">üåá</div>
                    <div class="sun-time" id="sunsetTime">--:--</div>
                    <div class="sun-label">Sunset</div>
                </div>
            </div>
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-item active" data-tab="weather">
                <span class="tab-icon">üå§Ô∏è</span>
                <span>Weather</span>
            </button>
            <button class="tab-item" data-tab="forecast">
                <span class="tab-icon">üìÖ</span>
                <span>Forecast</span>
            </button>
            <button class="tab-item" data-tab="maps">
                <span class="tab-icon">üó∫Ô∏è</span>
                <span>Maps</span>
            </button>
            <button class="tab-item" data-tab="more">
                <span class="tab-icon">‚ãØ</span>
                <span>More</span>
            </button>
        </div>
    </div>

    <script>
        // ========== INITIALIZATION ==========
        const tg = window.Telegram.WebApp;
        let userLocation = null;
        let currentWeatherData = null;
        let animationIntervals = [];
        let activeAnimations = {
            clouds: 0,
            rain: 0,
            snow: 0,
            wind: 0
        };

        // Initialize Telegram Web App
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#ffffff');
        tg.setBackgroundColor('#ffffff');

        // Apply Telegram theme colors
        function applyTelegramTheme() {
            const theme = tg.themeParams;
            if (theme) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', theme.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', theme.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', theme.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', theme.link_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-color', theme.button_color || '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', theme.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', theme.secondary_bg_color || '#f1f1f1');
            }
        }

        // ========== LOCATION MANAGEMENT ==========
        async function initApp() {
            applyTelegramTheme();
            
            // Check for saved location
            const savedLocation = localStorage.getItem('weatherflow_location');
            if (savedLocation) {
                userLocation = JSON.parse(savedLocation);
                loadWeatherData();
                return;
            }
            
            // Show location screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('locationScreen').classList.add('fade-in');
                }, 300);
            }, 1000);
            
            setupEventListeners();
        }

        function setupEventListeners() {
            // Telegram location
            document.getElementById('useTelegramLocation').addEventListener('click', requestTelegramLocation);
            
            // Default location
            document.getElementById('useDefaultLocation').addEventListener('click', () => {
                userLocation = { latitude: 40.7128, longitude: -74.0060, name: 'New York, USA' };
                selectLocation();
            });
            
            // Search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', debounce(searchLocation, 500));
            
            // Tab switching
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    // Handle tab switching here
                });
            });
        }

        async function requestTelegramLocation() {
            try {
                showLoading('Getting your location...');
                const location = await tg.requestLocation();
                if (location) {
                    userLocation = {
                        latitude: location.latitude,
                        longitude: location.longitude,
                        source: 'telegram'
                    };
                    await reverseGeocode();
                    selectLocation();
                }
            } catch (error) {
                console.error('Location error:', error);
                showError('Could not get location. Please try search.');
            }
        }

        async function reverseGeocode() {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.latitude}&lon=${userLocation.longitude}`
                );
                const data = await response.json();
                if (data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    const country = data.address.country;
                    userLocation.name = `${city}, ${country}`;
                }
            } catch (error) {
                userLocation.name = `${userLocation.latitude.toFixed(2)}, ${userLocation.longitude.toFixed(2)}`;
            }
        }

        async function searchLocation(query) {
            if (query.length < 2) return;
            
            try {
                const response = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5`
                );
                const data = await response.json();
                
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = '';
                
                if (data.results) {
                    data.results.forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'search-result';
                        div.innerHTML = `
                            <div>${result.name}</div>
                            <div class="subtitle">${result.country || ''}</div>
                        `;
                        div.addEventListener('click', () => {
                            userLocation = {
                                latitude: result.latitude,
                                longitude: result.longitude,
                                name: result.name
                            };
                            selectLocation();
                        });
                        resultsContainer.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function selectLocation() {
            localStorage.setItem('weatherflow_location', JSON.stringify(userLocation));
            document.getElementById('locationScreen').classList.remove('fade-in');
            document.getElementById('locationScreen').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('locationScreen').style.display = 'none';
                loadWeatherData();
            }, 300);
        }

        // ========== WEATHER DATA ==========
        async function loadWeatherData() {
            showLoading('Loading weather...');
            
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.latitude}&longitude=${userLocation.longitude}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,visibility,wind_speed_10m,wind_gusts_10m,cloud_cover,uv_index&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&timezone=auto&forecast_days=3`;
                
                const response = await fetch(weatherUrl);
                currentWeatherData = await response.json();
                
                updateWeatherUI();
                updateDynamicEnvironment();
                
                // Show weather app
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('fade-out');
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('weatherApp').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('weatherApp').classList.add('fade-in');
                        }, 50);
                    }, 300);
                }, 500);
                
            } catch (error) {
                console.error('Weather data error:', error);
                showError('Failed to load weather data');
            }
        }

        function updateWeatherUI() {
            const current = currentWeatherData.current_weather;
            const daily = currentWeatherData.daily;
            const hourly = currentWeatherData.hourly;
            const currentIndex = new Date().getHours();
            
            // Update location and time
            document.getElementById('locationName').textContent = userLocation.name;
            document.getElementById('locationTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Update temperature
            document.getElementById('temperature').textContent = Math.round(current.temperature);
            
            // Update condition
            document.getElementById('weatherCondition').textContent = getWeatherDescription(current.weathercode);
            
            // Update hi/low
            document.getElementById('hiLow').textContent = 
                `H: ${Math.round(daily.temperature_2m_max[0])}¬∞ L: ${Math.round(daily.temperature_2m_min[0])}¬∞`;
            
            // Update feels like
            document.getElementById('feelsLikeValue').textContent = 
                `${Math.round(hourly.apparent_temperature[currentIndex])}¬∞`;
            
            // Update details
            document.getElementById('humidityValue').textContent = 
                Math.round(hourly.relative_humidity_2m[currentIndex]);
            document.getElementById('windValue').textContent = 
                Math.round(current.windspeed);
            document.getElementById('visibilityValue').textContent = 
                (hourly.visibility[currentIndex] / 1000).toFixed(1);
            
            // Update sunrise/sunset
            const sunrise = new Date(daily.sunrise[0]);
            const sunset = new Date(daily.sunset[0]);
            document.getElementById('sunriseTime').textContent = 
                sunrise.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('sunsetTime').textContent = 
                sunset.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Update UV
            const uvIndex = Math.round(hourly.uv_index[currentIndex]);
            document.getElementById('uvValue').textContent = uvIndex;
            document.getElementById('uvDescription').textContent = getUVDescription(uvIndex);
            document.getElementById('uvBar').style.width = `${Math.min(100, uvIndex * 10)}%`;
            
            // Update hourly forecast
            updateHourlyForecast();
            
            // Apply weather-based background
            applyWeatherBackground(current.weathercode, current.is_day);
        }

        function updateHourlyForecast() {
            const hourly = currentWeatherData.hourly;
            const container = document.getElementById('hourlyForecast');
            container.innerHTML = '';
            
            const currentHour = new Date().getHours();
            
            for (let i = 0; i < 24; i += 3) {
                const hourIndex = currentHour + i;
                if (hourIndex >= hourly.time.length) break;
                
                const hourTime = new Date(hourly.time[hourIndex]);
                const hourItem = document.createElement('div');
                hourItem.className = 'hour-item';
                
                const timeStr = hourTime.getHours().toString().padStart(2, '0') + ':00';
                const temp = Math.round(hourly.temperature_2m[hourIndex]);
                const weatherCode = hourly.weathercode[hourIndex];
                
                hourItem.innerHTML = `
                    <div class="hour-time">${timeStr}</div>
                    <div class="hour-icon">${getWeatherEmoji(weatherCode)}</div>
                    <div class="hour-temp">${temp}¬∞</div>
                `;
                
                container.appendChild(hourItem);
            }
        }

        // ========== OPTIMIZED DYNAMIC ENVIRONMENT ==========
        function updateDynamicEnvironment() {
            if (!currentWeatherData) return;
            
            // Clear existing animations
            clearAllAnimations();
            
            const current = currentWeatherData.current_weather;
            const hourly = currentWeatherData.hourly;
            const currentIndex = new Date().getHours();
            
            const cloudCover = hourly.cloud_cover[currentIndex] || 0;
            const precipitation = hourly.precipitation[currentIndex] || 0;
            const windSpeed = current.windspeed || 0;
            const visibility = hourly.visibility[currentIndex] || 10000;
            const weatherCode = current.weathercode;
            
            const environment = document.getElementById('environment');
            
            // Sun/Moon (always present)
            const sunMoon = document.createElement('div');
            sunMoon.className = `sun-moon ${current.is_day ? 'day' : 'night'}`;
            environment.appendChild(sunMoon);
            
            // Limited clouds (max 3)
            if (cloudCover > 20) {
                const cloudCount = Math.min(3, Math.floor(cloudCover / 33));
                for (let i = 0; i < cloudCount; i++) {
                    createCloud(windSpeed);
                }
            }
            
            // Limited precipitation
            if (precipitation > 0.1) {
                const isSnow = weatherCode >= 71 && weatherCode <= 77;
                if (isSnow) {
                    createSnow(2); // Max 2 snow intervals
                } else {
                    createRain(2); // Max 2 rain intervals
                }
            }
            
            // Wind lines (only if significant)
            if (windSpeed > 15) {
                createWindLines(1); // Only 1 wind line
            }
            
            // Fog effect
            updateFogEffect(visibility);
            
            // Position sun/moon based on time
            updateSunMoonPosition();
        }

        function createCloud(windSpeed) {
            if (activeAnimations.clouds >= 3) return;
            
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            
            const size = 40 + Math.random() * 40;
            const top = 10 + Math.random() * 30;
            
            cloud.style.width = `${size}px`;
            cloud.style.height = `${size * 0.4}px`;
            cloud.style.top = `${top}%`;
            cloud.style.left = `-${size}px`;
            cloud.style.opacity = 0.3 + Math.random() * 0.4;
            
            // Slower animation for better performance
            const duration = 40 + (20 - Math.min(20, windSpeed));
            cloud.style.animationDuration = `${duration}s`;
            
            document.getElementById('environment').appendChild(cloud);
            activeAnimations.clouds++;
            
            // Clean up after animation
            setTimeout(() => {
                if (cloud.parentNode) {
                    cloud.parentNode.removeChild(cloud);
                    activeAnimations.clouds--;
                }
            }, duration * 1000);
        }

        function createRain(maxIntervals = 2) {
            if (activeAnimations.rain >= maxIntervals) return;
            
            const interval = setInterval(() => {
                if (activeAnimations.rain >= 15) return; // Max 15 drops total
                
                for (let i = 0; i < 3; i++) { // Only 3 drops per interval
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = `${Math.random() * 100}%`;
                    drop.style.top = '-20px';
                    drop.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
                    
                    document.getElementById('environment').appendChild(drop);
                    activeAnimations.rain++;
                    
                    setTimeout(() => {
                        if (drop.parentNode) {
                            drop.parentNode.removeChild(drop);
                            activeAnimations.rain--;
                        }
                    }, 2000);
                }
            }, 300); // Reduced frequency
            
            animationIntervals.push(interval);
        }

        function createSnow(maxIntervals = 2) {
            if (activeAnimations.snow >= maxIntervals) return;
            
            const interval = setInterval(() => {
                if (activeAnimations.snow >= 10) return; // Max 10 flakes total
                
                for (let i = 0; i < 2; i++) { // Only 2 flakes per interval
                    const flake = document.createElement('div');
                    flake.className = 'snow-flake';
                    flake.style.left = `${Math.random() * 100}%`;
                    flake.style.top = '-10px';
                    flake.style.animationDuration = `${3 + Math.random() * 2}s`;
                    
                    document.getElementById('environment').appendChild(flake);
                    activeAnimations.snow++;
                    
                    setTimeout(() => {
                        if (flake.parentNode) {
                            flake.parentNode.removeChild(flake);
                            activeAnimations.snow--;
                        }
                    }, 5000);
                }
            }, 500); // Reduced frequency
            
            animationIntervals.push(interval);
        }

        function createWindLines(maxLines = 1) {
            if (activeAnimations.wind >= maxLines) return;
            
            const line = document.createElement('div');
            line.className = 'wind-line';
            line.style.top = `${20 + Math.random() * 60}%`;
            line.style.left = '-100px';
            line.style.width = `${100 + Math.random() * 100}px`;
            
            document.getElementById('environment').appendChild(line);
            activeAnimations.wind++;
            
            setTimeout(() => {
                if (line.parentNode) {
                    line.parentNode.removeChild(line);
                    activeAnimations.wind--;
                }
            }, 20000);
        }

        function updateFogEffect(visibility) {
            const fog = document.getElementById('fogOverlay');
            const fogIntensity = Math.min(0.3, 1 - (visibility / 10000));
            fog.style.opacity = fogIntensity;
            fog.style.backdropFilter = `blur(${Math.min(3, fogIntensity * 10)}px)`;
        }

        function updateSunMoonPosition() {
            const now = new Date();
            const hour = now.getHours();
            const sunMoon = document.querySelector('.sun-moon');
            
            if (sunMoon) {
                const progress = hour / 24;
                const x = progress * 100;
                const y = Math.sin(progress * Math.PI) * 60 + 20;
                
                sunMoon.style.right = `calc(${x}% - 30px)`;
                sunMoon.style.top = `${y}%`;
            }
        }

        function clearAllAnimations() {
            animationIntervals.forEach(clearInterval);
            animationIntervals = [];
            activeAnimations = { clouds: 0, rain: 0, snow: 0, wind: 0 };
            
            const environment = document.getElementById('environment');
            environment.innerHTML = '';
        }

        // ========== UTILITY FUNCTIONS ==========
        function applyWeatherBackground(weatherCode, isDay) {
            const header = document.getElementById('weatherHeader');
            
            // Clear existing classes
            header.className = 'weather-header';
            
            // Apply appropriate gradient
            if (weatherCode === 0) {
                header.style.background = isDay ? 'var(--clear-day)' : 'var(--clear-night)';
            } else if (weatherCode >= 1 && weatherCode <= 3) {
                header.style.background = 'var(--cloudy)';
            } else if (weatherCode >= 51 && weatherCode <= 67) {
                header.style.background = 'var(--rainy)';
            } else if (weatherCode >= 71 && weatherCode <= 77) {
                header.style.background = 'var(--snowy)';
            } else if (weatherCode >= 95 && weatherCode <= 99) {
                header.style.background = 'var(--stormy)';
            } else if (weatherCode === 45 || weatherCode === 48) {
                header.style.background = 'var(--foggy)';
            }
            
            header.style.color = 'white';
        }

        function getWeatherDescription(code) {
            const descriptions = {
                0: 'Clear', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Foggy', 48: 'Rime Fog',
                51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle',
                61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain',
                71: 'Light Snow', 73: 'Snow', 75: 'Heavy Snow',
                77: 'Snow Grains', 80: 'Light Showers', 81: 'Showers', 82: 'Heavy Showers',
                85: 'Light Snow Showers', 86: 'Snow Showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with Hail', 99: 'Heavy Thunderstorm'
            };
            return descriptions[code] || 'Unknown';
        }

        function getWeatherEmoji(code) {
            const emojis = {
                0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
                45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
                51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
                61: 'üå¶Ô∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
                71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
                77: 'üå®Ô∏è', 80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: 'üåßÔ∏è',
                85: 'üå®Ô∏è', 86: 'üå®Ô∏è',
                95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
            };
            return emojis[code] || '‚òÄÔ∏è';
        }

        function getUVDescription(uvIndex) {
            if (uvIndex <= 2) return 'Low';
            if (uvIndex <= 5) return 'Moderate';
            if (uvIndex <= 7) return 'High';
            if (uvIndex <= 10) return 'Very High';
            return 'Extreme';
        }

        function showLoading(message) {
            const loading = document.getElementById('loadingScreen');
            const text = loading.querySelector('.loading-text');
            text.textContent = message;
            loading.style.display = 'flex';
            loading.classList.remove('fade-out');
            loading.classList.add('fade-in');
        }

        function showError(message) {
            alert(message); // In production, use a better error display
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ========== INITIALIZE APP ==========
        document.addEventListener('DOMContentLoaded', initApp);

        // Update time every minute
        setInterval(() => {
            if (document.getElementById('locationTime')) {
                document.getElementById('locationTime').textContent = 
                    new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }, 60000);

        // Update sun position every 10 minutes
        setInterval(updateSunMoonPosition, 600000);

        // Clean up animations on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearAllAnimations();
            } else if (currentWeatherData) {
                updateDynamicEnvironment();
            }
        });

    </script>
</body>
</html>