<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WeatherFlow - Material 3 Expressive</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { locationManager, init } from 'https://unpkg.com/@telegram-apps/sdk?module';
        window.TelegramSDK = { locationManager, init };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,300..700,0..1,-25..200" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Dynamic weather colors - will be updated by JS */
            --weather-primary: #6750A4;
            --weather-secondary: #FFB2FF;
            --weather-gradient: linear-gradient(135deg, #6750A4 0%, #FFB2FF 100%);
            --weather-surface: rgba(255, 255, 255, 0.95);
            --weather-on-gradient: #FFFFFF;
            --weather-on-surface: #1C1B1F;
            
            /* Animation Speeds */
            --animation-slow: 800ms;
            --animation-medium: 400ms;
            --animation-fast: 200ms;
            
            /* Elevation */
            --elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-3: 0px 4px 8px 4px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            
            /* Shapes */
            --shape-extra-large: 28px;
            --shape-large: 20px;
            --shape-medium: 16px;
            
            /* Safe Area Insets */
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }

        body {
            background: var(--weather-gradient);
            color: var(--weather-on-gradient);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            transition: background var(--animation-slow) ease;
            overflow-x: hidden;
            position: relative;
            will-change: background;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        html {
            height: -webkit-fill-available;
        }

        /* Fixed Header (appears on scroll) */
        .fixed-header {
            position: fixed;
            top: max(0px, var(--safe-area-top));
            left: 0;
            right: 0;
            background: transparent;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2000;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transform: translate3d(0, -100%, 0);
            transition: transform var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            will-change: transform;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fixed-header.visible {
            transform: translate3d(0, 0, 0);
        }

        .header-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--weather-on-gradient);
            opacity: 0;
            transform: translate3d(0, -10px, 0);
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .header-title.visible {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }

        /* Main Title (expressive) */
        .main-title {
            position: relative;
            z-index: 10;
            margin-bottom: 40px;
            transform: translate3d(0, 0, 0);
            will-change: transform, font-size, opacity;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .main-title h1 {
            font-size: 57px;
            font-weight: 400;
            line-height: 1.1;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            color: var(--weather-on-gradient);
            transform-origin: left center;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .main-title.compact h1 {
            font-size: 32px;
            line-height: 1.2;
            letter-spacing: -0.25px;
        }

        .location-details {
            font-size: 16px;
            opacity: 0.9;
            color: var(--weather-on-gradient);
            display: flex;
            gap: 12px;
            align-items: center;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .main-title.compact .location-details {
            opacity: 0;
            transform: translate3d(0, -10px, 0);
        }

        /* Enhanced Retractable Search */
        .search-wrapper {
            position: fixed;
            top: max(20px, calc(var(--safe-area-top) + 20px));
            left: 50%;
            transform: translate3d(-50%, 0, 0);
            z-index: 100;
            width: 90%;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            will-change: transform, width;
        }

        .search-wrapper.collapsed {
            width: 48px;
            left: auto;
            right: 20px;
            transform: translate3d(0, 0, 0);
        }

        .search-pill {
            flex: 1;
            background: var(--weather-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 100px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--elevation-2);
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            transform: translate3d(0, 0, 0);
            overflow: hidden;
        }

        .search-wrapper.collapsed .search-pill {
            width: 48px;
            height: 48px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 400;
            color: var(--weather-on-surface);
            outline: none;
            font-family: inherit;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            opacity: 1;
            width: 100%;
        }

        .search-wrapper.collapsed .search-input {
            opacity: 0;
            width: 0;
            flex: 0;
        }

        .search-icon {
            color: var(--weather-primary);
            font-size: 20px;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            transform: translate3d(0, 0, 0);
        }

        .search-wrapper.collapsed .search-icon {
            margin: 0;
        }

        .search-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--weather-primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--elevation-2);
            cursor: pointer;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            flex-shrink: 0;
            will-change: transform;
            transform: translate3d(0, 0, 0);
        }

        .search-button:hover {
            transform: scale3d(1.05, 1.05, 1);
        }

        .search-wrapper.collapsed .search-button {
            opacity: 0;
            transform: scale3d(0.8, 0.8, 1);
            pointer-events: none;
        }

        /* Main Container with Lowering Effect */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 60vh 20px 100px;
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: padding var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .container.scrolled {
            padding-top: 120px;
        }

        /* Bottom Switch with Safe Area */
        .bottom-switch {
            position: fixed;
            bottom: max(20px, calc(var(--safe-area-bottom) + 20px));
            left: 50%;
            transform: translate3d(-50%, 0, 0);
            background: var(--weather-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 100px;
            padding: 6px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--elevation-3);
            z-index: 100;
            will-change: transform;
            transform: translate3d(-50%, 0, 0);
        }

        /* GPU Accelerated Animations */
        .weather-item {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            transition: transform var(--animation-fast) cubic-bezier(0.2, 0, 0, 1);
        }

        .weather-item:hover {
            transform: translate3d(0, -2px, 0);
        }

        .hour-item {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            transition: transform var(--animation-fast) cubic-bezier(0.2, 0, 0, 1);
        }

        .hour-item:hover {
            transform: translate3d(0, -4px, 0);
        }

        .module-card {
            transform: translate3d(0, 0, 0);
            will-change: transform;
            transition: transform var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .module-card:hover {
            transform: translate3d(0, -4px, 0);
        }

        /* Enhanced Weather Elements with GPU Acceleration */
        .sun, .moon, .cloud, .rain-drop, .snow-flake, .lightning, .star {
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .main-title h1 {
                font-size: 48px;
            }
            
            .main-title.compact h1 {
                font-size: 24px;
            }
            
            .container {
                padding: 50vh 16px 100px;
            }
            
            .container.scrolled {
                padding-top: 100px;
            }
            
            .search-wrapper {
                top: max(16px, calc(var(--safe-area-top) + 16px));
                width: calc(100% - 32px);
            }
        }

        /* Add padding for Telegram header */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--safe-area-top);
            background: transparent;
            z-index: 3000;
            pointer-events: none;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #808080 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            transition: opacity var(--animation-medium) ease;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* Keep existing styles below - they remain unchanged except for safe area adjustments */
        /* ... existing styles continue ... */
    </style>
</head>
<body class="clear-day">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen" style="background: #808080;">
        <div class="canvas-container">
            <canvas id="wigglyCanvas"></canvas>
        </div>
        <div class="loading-text" id="loadingText">Detecting your location...</div>
    </div>

    <!-- Fixed Header -->
    <div class="fixed-header" id="fixedHeader">
        <h1 class="header-title" id="headerLocationName"></h1>
        <div class="header-search-icon" id="headerSearchIcon">
            <span class="material-symbols-rounded">search</span>
        </div>
    </div>

    <!-- Weather Elements Container -->
    <div class="weather-elements" id="weatherElements"></div>

    <!-- Retractable Search Bar -->
    <div class="search-wrapper" id="searchWrapper">
        <div class="search-pill">
            <span class="material-symbols-rounded search-icon">search</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search location">
        </div>
        <button class="search-button" id="searchButton">
            <span class="material-symbols-rounded">arrow_forward</span>
        </button>
    </div>

    <!-- Main App Content -->
    <div class="container" id="appContainer" style="display: none;">
        <!-- Expressive Title Section -->
        <div class="main-title" id="mainTitle">
            <h1 id="locationName">Loading...</h1>
            <div class="location-details on-gradient">
                <span id="elevation">-- m</span>
                <span>â€¢</span>
                <span id="timezone">--</span>
            </div>
        </div>

        <!-- Current Weather Card -->
        <div class="weather-card" id="currentWeather">
            <!-- ... existing weather card content ... -->
        </div>

        <!-- Tab Contents -->
        <!-- ... existing tab contents ... -->
    </div>

    <!-- Bottom Switch Pill -->
    <div class="bottom-switch">
        <button class="switch-option active" data-view="current">Current</button>
        <button class="switch-option" data-view="map">Maps</button>
        <button class="switch-option" data-view="history">History</button>
    </div>

    <script type="module">
        // ==================== ENHANCEMENTS IMPLEMENTATION ====================

        // Global variables for enhancement features
        let scrollTimeout = null;
        let searchCollapseTimer = null;
        let lastScrollPosition = 0;
        let isSearchExpanded = true;

        // Initialize enhancement features
        function initEnhancements() {
            // Initialize scroll handling for One UI lowering effect
            initScrollHandling();
            
            // Initialize retractable search
            initRetractableSearch();
            
            // Initialize Telegram header color adaptation
            initTelegramHeader();
            
            // Initialize haptic feedback
            initHapticFeedback();
        }

        // 1. One UI Lowering Effect
        function initScrollHandling() {
            const appContainer = document.getElementById('appContainer');
            const mainTitle = document.getElementById('mainTitle');
            const fixedHeader = document.getElementById('fixedHeader');
            const headerTitle = document.getElementById('headerLocationName');
            const locationName = document.getElementById('locationName');

            let isScrolled = false;

            window.addEventListener('scroll', () => {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollThreshold = 100;

                // Update header visibility
                if (scrollTop > scrollThreshold) {
                    if (!isScrolled) {
                        isScrolled = true;
                        appContainer.classList.add('scrolled');
                        mainTitle.classList.add('compact');
                        fixedHeader.classList.add('visible');
                        
                        // Fade in header title
                        setTimeout(() => {
                            headerTitle.textContent = locationName.textContent;
                            headerTitle.classList.add('visible');
                        }, 50);
                    }
                } else {
                    if (isScrolled) {
                        isScrolled = false;
                        appContainer.classList.remove('scrolled');
                        mainTitle.classList.remove('compact');
                        fixedHeader.classList.remove('visible');
                        headerTitle.classList.remove('visible');
                    }
                }

                // Parallax effect for main title
                if (!isScrolled) {
                    const parallax = scrollTop * 0.5;
                    mainTitle.style.transform = `translate3d(0, ${parallax}px, 0)`;
                }

                // Update scroll position for haptic feedback
                handleScrollHaptics(scrollTop);
                
                // Reset search collapse timer on scroll
                resetSearchCollapseTimer();
            }, { passive: true });
        }

        // 2. Adaptive Telegram Header
        function initTelegramHeader() {
            // Function to update Telegram header color based on weather
            function updateTelegramHeader() {
                if (window.Telegram?.WebApp) {
                    // Extract color from current gradient
                    const bodyStyle = window.getComputedStyle(document.body);
                    const gradient = bodyStyle.backgroundImage;
                    
                    // Try to extract primary color from gradient
                    let primaryColor = '#6750A4'; // Default
                    
                    if (gradient.includes('linear-gradient')) {
                        const matches = gradient.match(/#[0-9A-Fa-f]{6}/g);
                        if (matches && matches[0]) {
                            primaryColor = matches[0];
                        }
                    }
                    
                    // Set Telegram header color
                    try {
                        Telegram.WebApp.setHeaderColor(primaryColor);
                        Telegram.WebApp.setBackgroundColor(primaryColor);
                    } catch (e) {
                        console.log('Telegram WebApp API not available');
                    }
                }
            }

            // Update header when weather changes
            const updateWeatherBackground = (weatherCode, isDay) => {
                // ... existing weather background update code ...
                
                // Then update Telegram header
                setTimeout(updateTelegramHeader, 100);
            };

            // Initial update
            setTimeout(updateTelegramHeader, 1000);
        }

        // 3. Retractable Search
        function initRetractableSearch() {
            const searchWrapper = document.getElementById('searchWrapper');
            const searchInput = document.getElementById('searchInput');
            const headerSearchIcon = document.getElementById('headerSearchIcon');
            
            // Collapse search after 15 seconds
            startSearchCollapseTimer();
            
            // Expand search when clicking on search icon or pill
            searchWrapper.addEventListener('click', (e) => {
                if (searchWrapper.classList.contains('collapsed')) {
                    expandSearch();
                    e.stopPropagation();
                }
            });
            
            searchInput.addEventListener('focus', () => {
                expandSearch();
                resetSearchCollapseTimer();
            });
            
            // Click anywhere to collapse (except when interacting with search)
            document.addEventListener('click', (e) => {
                if (isSearchExpanded && 
                    !searchWrapper.contains(e.target) && 
                    !headerSearchIcon.contains(e.target)) {
                    collapseSearch();
                }
            });
            
            // Header search icon click
            headerSearchIcon.addEventListener('click', () => {
                expandSearch();
                searchInput.focus();
            });
        }

        function startSearchCollapseTimer() {
            searchCollapseTimer = setTimeout(() => {
                collapseSearch();
            }, 15000); // 15 seconds
        }

        function resetSearchCollapseTimer() {
            clearTimeout(searchCollapseTimer);
            if (isSearchExpanded) {
                startSearchCollapseTimer();
            }
        }

        function expandSearch() {
            const searchWrapper = document.getElementById('searchWrapper');
            const searchInput = document.getElementById('searchInput');
            
            if (!isSearchExpanded) {
                searchWrapper.classList.remove('collapsed');
                isSearchExpanded = true;
                
                // Trigger haptic feedback
                triggerHaptic('light');
                
                // Focus input with delay for animation
                setTimeout(() => {
                    searchInput.focus();
                }, 200);
                
                // Restart collapse timer
                resetSearchCollapseTimer();
            }
        }

        function collapseSearch() {
            const searchWrapper = document.getElementById('searchWrapper');
            const searchInput = document.getElementById('searchInput');
            
            if (isSearchExpanded && !searchInput.value.trim()) {
                searchWrapper.classList.add('collapsed');
                isSearchExpanded = false;
                searchInput.blur();
                
                // Trigger haptic feedback
                triggerHaptic('light');
            }
        }

        // 4. Haptic Feedback Integration
        function initHapticFeedback() {
            // Add haptic feedback to interactive elements
            const interactiveElements = document.querySelectorAll(
                '.switch-option, .search-button, .module-card, .weather-item, .hour-item, .history-button, .retry-button'
            );
            
            interactiveElements.forEach(element => {
                element.addEventListener('click', () => {
                    triggerHaptic('light');
                });
                
                element.addEventListener('touchstart', () => {
                    triggerHaptic('light');
                }, { passive: true });
            });
        }

        function triggerHaptic(type = 'light') {
            if (window.Telegram?.WebApp?.HapticFeedback) {
                try {
                    switch(type) {
                        case 'light':
                            Telegram.WebApp.HapticFeedback.impactOccurred('light');
                            break;
                        case 'medium':
                            Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                            break;
                        case 'heavy':
                            Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                            break;
                        case 'success':
                            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                            break;
                        case 'error':
                            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                            break;
                    }
                } catch (e) {
                    console.log('Haptic feedback not available');
                }
            }
        }

        function handleScrollHaptics(scrollTop) {
            // Trigger haptic feedback on significant scroll
            const scrollDelta = Math.abs(scrollTop - lastScrollPosition);
            
            if (scrollDelta > 100) {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    triggerHaptic('light');
                }, 150);
            }
            
            lastScrollPosition = scrollTop;
        }

        // ==================== EXISTING CODE WITH ENHANCEMENTS ====================
        
        // WIGGLY RING LOADING ANIMATION (keep existing code)
        (function() {
            // ... existing wiggly ring code ...
        })();

        // Initialize the app with enhancements
        async function initApp() {
            try {
                updateLoadingText('Initializing...');
                
                // Initialize Telegram SDK
                init();
                
                // Initialize enhancement features
                initEnhancements();
                
                // Set up switch functionality
                setupSwitch();
                
                // Set up search functionality
                setupSearch();
                
                // ... rest of existing init code ...
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize app. Please try again.');
            }
        }

        // Modified setupSearch to work with new retractable search
        function setupSearch() {
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('searchInput');
            
            searchButton.addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                    triggerHaptic('success');
                }
            });
            
            // Add input event for search
            searchInput.addEventListener('input', resetSearchCollapseTimer);
        }

        // Modified handleSearch to include haptics
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                triggerHaptic('error');
                return;
            }
            
            triggerHaptic('medium');
            // ... existing search logic ...
        }

        // Update updateCurrentWeatherUI to sync header title
        function updateCurrentWeatherUI(data) {
            // ... existing update code ...
            
            // Sync header title
            const headerTitle = document.getElementById('headerLocationName');
            const locationName = document.getElementById('locationName');
            if (headerTitle.textContent !== locationName.textContent) {
                headerTitle.textContent = locationName.textContent;
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Safe area adjustment for map
        function initWeatherMap() {
            // ... existing map code ...
            
            // Adjust map for safe areas in fullscreen
            if (elements.mapTab.classList.contains('map-fullscreen')) {
                elements.mapTab.style.top = 'var(--safe-area-top)';
                elements.mapTab.style.height = 'calc(100vh - var(--safe-area-top) - var(--safe-area-bottom))';
            }
        }

    </script>
</body>
</html>