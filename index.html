<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherFlow - Material 3 Expressive</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,700,0..1,-25..200" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 800 !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            /* Material 3 Expressive Color System */
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --secondary: #625B71;
            --on-secondary: #FFFFFF;
            --secondary-container: #E8DEF8;
            --on-secondary-container: #1D192B;
            --tertiary: #7D5260;
            --on-tertiary: #FFFFFF;
            --tertiary-container: #FFD8E4;
            --on-tertiary-container: #31111D;
            --surface: #FEF7FF;
            --on-surface: #1C1B1F;
            --surface-variant: #E7E0EC;
            --on-surface-variant: #49454F;
            --outline: #79747E;
            --outline-variant: #CAC4D0;
            --shadow: #000000;
            
            /* Material 3 Expressive Gradients */
            --expressive-gradient-1: linear-gradient(135deg, #6750A4 0%, #FFB2FF 100%);
            --expressive-gradient-2: linear-gradient(135deg, #007AFF 0%, #00D4FF 100%);
            --expressive-gradient-3: linear-gradient(135deg, #30D158 0%, #A3FFA3 100%);
            --expressive-gradient-4: linear-gradient(135deg, #FF9F0A 0%, #FFD60A 100%);
            --expressive-gradient-5: linear-gradient(135deg, #BF5AF2 0%, #FF9FFF 100%);
            
            /* Animation Speeds */
            --animation-slow: 800ms;
            --animation-medium: 400ms;
            --animation-fast: 200ms;
            
            /* Expressive Elevation */
            --elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-3: 0px 4px 8px 4px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-4: 0px 8px 12px 6px rgba(0, 0, 0, 0.3), 0px 4px 4px 0px rgba(0, 0, 0, 0.15);
            
            /* Expressive Shapes */
            --shape-extra-large: 28px;
            --shape-large: 20px;
            --shape-medium: 16px;
            --shape-small: 12px;
            --shape-extra-small: 8px;
        }

        body {
            background: var(--expressive-gradient-1);
            color: var(--on-surface);
            min-height: 100vh;
            transition: all var(--animation-slow) cubic-bezier(0.2, 0, 0, 1);
            overflow-x: hidden;
            position: relative;
        }

        /* Material 3 Expressive Loading Animation - Crinkled Wavy Ring */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--expressive-gradient-1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .expressive-loader {
            width: 120px;
            height: 120px;
            position: relative;
            margin-bottom: 32px;
        }

        .expressive-loader::before,
        .expressive-loader::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 6px solid transparent;
            border-top-color: var(--on-primary);
            animation: expressive-rotate 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            filter: 
                drop-shadow(0 0 8px rgba(255, 255, 255, 0.8))
                drop-shadow(0 0 16px rgba(255, 255, 255, 0.4));
        }

        .expressive-loader::after {
            animation-delay: -1s;
            border-top-color: var(--primary-container);
            border-width: 4px;
            filter: 
                drop-shadow(0 0 12px rgba(103, 80, 164, 0.6))
                drop-shadow(0 0 24px rgba(103, 80, 164, 0.3));
        }

        .expressive-loader::before {
            border-style: dashed;
            border-width: 8px;
            border-image: radial-gradient(circle at 30% 50%, 
                var(--on-primary) 0%,
                transparent 20%,
                var(--on-primary) 40%,
                transparent 60%,
                var(--on-primary) 80%,
                transparent 100%
            ) 1;
        }

        @keyframes expressive-rotate {
            0% {
                transform: rotate(0deg) scale(1);
                border-radius: 50% 30% 70% 50%;
            }
            25% {
                transform: rotate(90deg) scale(1.1);
                border-radius: 60% 40% 60% 40%;
            }
            50% {
                transform: rotate(180deg) scale(1);
                border-radius: 50% 50% 40% 60%;
            }
            75% {
                transform: rotate(270deg) scale(0.9);
                border-radius: 40% 60% 50% 50%;
            }
            100% {
                transform: rotate(360deg) scale(1);
                border-radius: 50% 30% 70% 50%;
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 900;
            color: var(--on-primary);
            letter-spacing: 0.5px;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 255, 255, 0.4);
            animation: expressive-pulse 2s ease-in-out infinite;
        }

        @keyframes expressive-pulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Expressive Typography with Gothic Bold */
        .expressive-display {
            font-size: 57px;
            font-weight: 900;
            line-height: 64px;
            letter-spacing: -0.25px;
            font-family: 'Inter', sans-serif;
        }

        .expressive-headline {
            font-size: 36px;
            font-weight: 900;
            line-height: 44px;
            letter-spacing: 0;
            font-family: 'Inter', sans-serif;
        }

        .expressive-title {
            font-size: 22px;
            font-weight: 900;
            line-height: 28px;
            letter-spacing: 0;
            font-family: 'Inter', sans-serif;
        }

        .expressive-body {
            font-size: 16px;
            font-weight: 900;
            line-height: 24px;
            letter-spacing: 0.5px;
            font-family: 'Inter', sans-serif;
        }

        .expressive-label {
            font-size: 14px;
            font-weight: 900;
            line-height: 20px;
            letter-spacing: 0.1px;
            font-family: 'Inter', sans-serif;
        }

        /* Dynamic Text Colors */
        .on-gradient {
            color: #FFFFFF !important;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.4),
                0 0 12px rgba(255, 255, 255, 0.3);
        }

        .on-surface {
            color: var(--on-surface) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Expressive Cards */
        .expressive-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--shape-extra-large);
            padding: 32px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-3);
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            color: var(--on-surface);
        }

        .expressive-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--elevation-4);
        }

        /* Floating Search Bar (Pill) */
        .search-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-pill {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-radius: 100px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: var(--elevation-2);
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .search-pill:focus-within {
            background: rgba(255, 255, 255, 1);
            box-shadow: var(--elevation-4);
            transform: translateY(-2px);
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 900;
            color: var(--on-surface);
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .search-input::placeholder {
            color: var(--outline);
            font-weight: 900;
        }

        .search-icon {
            color: var(--primary);
            font-size: 24px;
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 24;
        }

        .search-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--elevation-2);
            cursor: pointer;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            flex-shrink: 0;
        }

        .search-button:hover {
            transform: scale(1.1) rotate(12deg);
            box-shadow: var(--elevation-4);
            background: var(--expressive-gradient-1);
        }

        .search-button .material-symbols-rounded {
            font-size: 24px;
            color: var(--on-primary);
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 24;
        }

        /* Bottom Switch Pill */
        .bottom-switch {
            position: fixed;
            bottom: 38px; /* Approximately 1cm from bottom */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-radius: 100px;
            padding: 8px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: var(--elevation-3);
            z-index: 100;
        }

        .switch-option {
            padding: 14px 32px;
            border: none;
            background: transparent;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 900;
            color: var(--on-surface-variant);
            cursor: pointer;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
            min-width: 120px;
            text-align: center;
        }

        .switch-option.active {
            background: var(--primary);
            color: var(--on-primary);
            box-shadow: var(--elevation-1);
        }

        .switch-option:not(.active):hover {
            background: rgba(103, 80, 164, 0.1);
            color: var(--primary);
        }

        /* Main Container */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 100px 20px 100px 20px; /* Extra padding for fixed elements */
            position: relative;
            z-index: 10;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Location Section */
        .location-section {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
        }

        .location-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .location-name {
            font-size: 36px;
            font-weight: 900;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .location-details {
            display: flex;
            justify-content: center;
            gap: 24px;
            font-size: 14px;
            font-weight: 900;
            opacity: 0.9;
        }

        /* Current Weather Card */
        .current-weather {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: var(--shape-extra-large);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-3);
            color: var(--on-surface);
        }

        .weather-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .temperature-section {
            display: flex;
            flex-direction: column;
        }

        .temperature {
            font-size: 96px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            letter-spacing: -4px;
        }

        .temp-unit {
            font-size: 36px;
            margin-top: 12px;
            margin-left: 4px;
            font-weight: 900;
        }

        .weather-description {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .weather-icon {
            width: 120px;
            height: 120px;
            font-size: 120px;
            color: var(--primary);
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48;
        }

        /* Weather Grid */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 32px;
        }

        .weather-item {
            background: rgba(103, 80, 164, 0.1);
            border-radius: var(--shape-large);
            padding: 20px;
            text-align: center;
            transition: all var(--animation-fast) cubic-bezier(0.2, 0, 0, 1);
            border: 1px solid rgba(103, 80, 164, 0.2);
        }

        .weather-item:hover {
            transform: translateY(-4px) scale(1.05);
            background: rgba(103, 80, 164, 0.15);
        }

        .weather-icon-small {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary);
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 24;
        }

        .weather-label {
            font-size: 12px;
            font-weight: 900;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .weather-value {
            font-size: 24px;
            font-weight: 900;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .weather-unit {
            font-size: 12px;
            font-weight: 900;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: expressive-slide-in var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        @keyframes expressive-slide-in {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tab-content.active {
            display: block;
        }

        /* Forecast Tab */
        .hourly-forecast {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 24px 0;
            margin-bottom: 24px;
            scrollbar-width: none;
        }

        .hourly-forecast::-webkit-scrollbar {
            display: none;
        }

        .hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 16px;
            border-radius: var(--shape-large);
            min-width: 100px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-1);
            transition: all var(--animation-fast) cubic-bezier(0.2, 0, 0, 1);
        }

        .hour-item:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--elevation-2);
        }

        .hour-time {
            font-size: 14px;
            font-weight: 900;
            margin-bottom: 12px;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        .hour-temp {
            font-size: 24px;
            font-weight: 900;
            margin: 12px 0;
            letter-spacing: -1px;
        }

        /* History Tab */
        .history-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            border-radius: var(--shape-extra-large);
            padding: 32px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-2);
        }

        .date-picker-container {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .date-input {
            flex: 1;
            padding: 20px;
            background: rgba(103, 80, 164, 0.1);
            border: 2px solid rgba(103, 80, 164, 0.2);
            border-radius: var(--shape-medium);
            font-size: 16px;
            font-weight: 900;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            font-family: 'Inter', sans-serif;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(103, 80, 164, 0.15);
            box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1);
        }

        .history-button {
            padding: 20px 32px;
            background: var(--primary);
            border: none;
            border-radius: var(--shape-medium);
            color: var(--on-primary);
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }

        .history-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--elevation-4);
            background: var(--expressive-gradient-1);
        }

        /* Expressive Modules */
        .expressive-modules {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .expressive-module {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            border-radius: var(--shape-large);
            padding: 28px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-2);
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
        }

        .expressive-module:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--elevation-4);
        }

        .module-icon {
            font-size: 32px;
            margin-bottom: 16px;
            color: var(--primary);
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 32;
        }

        .module-title {
            font-size: 14px;
            font-weight: 900;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .module-value {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 4px;
            line-height: 1.2;
            letter-spacing: -2px;
        }

        .module-unit {
            font-size: 14px;
            font-weight: 900;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 100px 16px 100px 16px;
            }
            
            .temperature {
                font-size: 72px;
                letter-spacing: -3px;
            }
            
            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .expressive-modules {
                grid-template-columns: 1fr;
            }
            
            .expressive-module {
                padding: 24px;
            }
            
            .module-value {
                font-size: 32px;
            }
            
            .switch-option {
                padding: 12px 24px;
                min-width: 100px;
                font-size: 14px;
            }
            
            .search-pill {
                padding: 14px 20px;
            }
            
            .search-button {
                width: 48px;
                height: 48px;
            }
        }

        /* Error State */
        .error-state {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--shape-extra-large);
            padding: 48px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--elevation-2);
        }

        .error-icon {
            font-size: 64px;
            color: var(--tertiary);
            margin-bottom: 24px;
            font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 200, 'opsz' 48;
        }

        .error-title {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }

        .error-message {
            opacity: 0.8;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .retry-button {
            padding: 18px 36px;
            background: var(--primary);
            border: none;
            border-radius: var(--shape-medium);
            color: var(--on-primary);
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            transition: all var(--animation-medium) cubic-bezier(0.2, 0, 0, 1);
            letter-spacing: 0.5px;
        }

        .retry-button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--elevation-4);
            background: var(--expressive-gradient-1);
        }

        /* Weather Animations */
        .weather-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.3;
            overflow: hidden;
        }

        .expressive-drop {
            position: absolute;
            width: 4px;
            height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.8));
            border-radius: 2px;
            animation: expressive-rain 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            filter: blur(1px);
        }

        @keyframes expressive-rain {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) translateX(20px) rotate(180deg);
                opacity: 0;
            }
        }

        /* Dynamic Background */
        body.clear-day {
            background: var(--expressive-gradient-4);
        }

        body.clear-night {
            background: var(--expressive-gradient-5);
        }

        body.cloudy {
            background: linear-gradient(135deg, #8E8E93 0%, #AEAEB2 100%);
        }

        body.rainy {
            background: var(--expressive-gradient-2);
        }

        body.snowy {
            background: linear-gradient(135deg, #E5E5EA 0%, #F2F2F7 100%);
        }

        body.stormy {
            background: linear-gradient(135deg, #5856D6 0%, #AF52DE 100%);
        }

        body.foggy {
            background: linear-gradient(135deg, #C7C7CC 0%, #D1D1D6 100%);
        }
    </style>
</head>
<body class="clear-day">
    <!-- Loading Screen with Material 3 Expressive Crinkled Wavy Ring -->
    <div class="loading-screen" id="loadingScreen">
        <div class="expressive-loader"></div>
        <div class="loading-text on-gradient" id="loadingText">DETECTING LOCATION</div>
    </div>

    <!-- Floating Search Bar -->
    <div class="search-container">
        <div class="search-pill">
            <span class="material-symbols-rounded search-icon">search</span>
            <input type="text" class="search-input" id="searchInput" placeholder="SEARCH LOCATION">
        </div>
        <button class="search-button" id="searchButton">
            <span class="material-symbols-rounded">arrow_forward</span>
        </button>
    </div>

    <!-- Main App Content -->
    <div class="container" id="appContainer" style="display: none;">
        <!-- Location Section -->
        <div class="location-section">
            <div class="location-header">
                <span class="material-symbols-rounded weather-icon-small">location_on</span>
                <h1 class="location-name on-gradient" id="locationName">LOADING...</h1>
            </div>
            <div class="location-details on-gradient">
                <span id="elevation">-- M</span>
                <span>•</span>
                <span id="timezone">--</span>
            </div>
        </div>

        <!-- Current Weather Card -->
        <div class="expressive-card" id="currentWeather">
            <div class="weather-main">
                <div class="temperature-section">
                    <div class="temperature on-surface">
                        <span id="currentTemp">--</span>
                        <span class="temp-unit on-surface">°C</span>
                    </div>
                    <div class="weather-description on-surface" id="weatherDescription">LOADING...</div>
                </div>
                <span class="material-symbols-rounded weather-icon" id="weatherIcon">
                    sunny
                </span>
            </div>
            <div class="weather-grid" id="weatherGrid">
                <!-- Weather items will be populated dynamically -->
            </div>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content active" id="currentTab">
            <div class="hourly-forecast" id="hourlyForecast">
                <!-- Hourly forecast items will be added here -->
            </div>
            <div class="expressive-modules">
                <div class="expressive-module" id="uvModule">
                    <span class="material-symbols-rounded module-icon">light_mode</span>
                    <div class="module-title on-surface">UV INDEX</div>
                    <div class="module-value on-surface" id="uvIndexValue">--</div>
                    <div class="module-unit on-surface" id="uvDescription">CURRENT LEVEL</div>
                </div>
                <div class="expressive-module" id="windModule">
                    <span class="material-symbols-rounded module-icon">air</span>
                    <div class="module-title on-surface">WIND GUST</div>
                    <div class="module-value on-surface" id="windGustValue">--</div>
                    <div class="module-unit on-surface">KM/H</div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="historyTab">
            <div class="history-controls">
                <div class="date-picker-container">
                    <input type="date" class="date-input on-surface" id="historyDate" max="">
                    <button class="history-button" onclick="loadHistoricalWeather()">
                        <span class="material-symbols-rounded">calendar_month</span>
                        LOAD HISTORY
                    </button>
                </div>
                <div id="historicalData">
                    <div style="text-align: center; padding: 48px;">
                        <span class="material-symbols-rounded" style="font-size: 64px; color: var(--outline); margin-bottom: 24px;">history</span>
                        <div class="expressive-body on-surface">SELECT A DATE TO VIEW HISTORICAL WEATHER DATA</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Switch Pill -->
    <div class="bottom-switch">
        <button class="switch-option active" data-view="current">CURRENT</button>
        <button class="switch-option" data-view="history">HISTORY</button>
    </div>

    <script>
        // ==================== INITIALIZATION ====================
        const tg = window.Telegram.WebApp;
        let userLocation = null;
        let currentWeatherData = null;
        
        // Initialize Telegram Web App
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        // Set Material 3 Expressive theme
        tg.setHeaderColor('#6750A4');
        tg.setBackgroundColor('#FEF7FF');

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            loadingText: document.getElementById('loadingText'),
            appContainer: document.getElementById('appContainer'),
            searchInput: document.getElementById('searchInput'),
            searchButton: document.getElementById('searchButton'),
            locationName: document.getElementById('locationName'),
            elevation: document.getElementById('elevation'),
            timezone: document.getElementById('timezone'),
            currentTemp: document.getElementById('currentTemp'),
            weatherDescription: document.getElementById('weatherDescription'),
            weatherIcon: document.getElementById('weatherIcon'),
            weatherGrid: document.getElementById('weatherGrid'),
            hourlyForecast: document.getElementById('hourlyForecast'),
            uvIndexValue: document.getElementById('uvIndexValue'),
            uvDescription: document.getElementById('uvDescription'),
            windGustValue: document.getElementById('windGustValue'),
            historyDate: document.getElementById('historyDate'),
            historicalData: document.getElementById('historicalData'),
            currentTab: document.getElementById('currentTab'),
            historyTab: document.getElementById('historyTab')
        };

        // Initialize the app
        async function initApp() {
            try {
                updateLoadingText('INITIALIZING');
                
                // Set up switch functionality
                setupSwitch();
                
                // Set up search functionality
                setupSearch();
                
                // Set up date picker
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                elements.historyDate.max = yesterday.toISOString().split('T')[0];
                
                const today = new Date();
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);
                elements.historyDate.value = oneYearAgo.toISOString().split('T')[0];
                
                // Get user location
                await getUserLocation();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('FAILED TO INITIALIZE APP. PLEASE TRY AGAIN.');
            }
        }

        // ==================== SWITCH FUNCTIONALITY ====================
        function setupSwitch() {
            const switchOptions = document.querySelectorAll('.switch-option');
            const tabContents = [elements.currentTab, elements.historyTab];
            
            switchOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Update active option
                    switchOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    
                    // Show corresponding content
                    const view = option.dataset.view;
                    tabContents.forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.id === `${view}Tab`) {
                            tab.classList.add('active');
                        }
                    });
                    
                    // Load data for history tab if needed
                    if (view === 'history') {
                        loadHistoricalWeather();
                    }
                });
            });
        }

        // ==================== SEARCH FUNCTIONALITY ====================
        function setupSearch() {
            elements.searchButton.addEventListener('click', handleSearch);
            elements.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Add expressive animation to search button
            elements.searchButton.addEventListener('mouseenter', () => {
                elements.searchButton.style.transform = 'scale(1.1) rotate(12deg)';
            });
            
            elements.searchButton.addEventListener('mouseleave', () => {
                elements.searchButton.style.transform = 'scale(1) rotate(0deg)';
            });
        }

        async function handleSearch() {
            const query = elements.searchInput.value.trim();
            if (!query) return;
            
            updateLoadingText('SEARCHING LOCATION');
            elements.loadingScreen.style.display = 'flex';
            elements.appContainer.style.display = 'none';
            
            try {
                const geocodeUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1`;
                const response = await fetch(geocodeUrl);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const location = data.results[0];
                    userLocation = {
                        latitude: location.latitude,
                        longitude: location.longitude
                    };
                    
                    // Update location display
                    elements.locationName.textContent = location.name.toUpperCase();
                    elements.elevation.textContent = `${Math.round(location.elevation || 0)} M`;
                    elements.timezone.textContent = location.timezone.split('/')[1]?.toUpperCase() || location.timezone;
                    
                    // Load weather data
                    await loadAllWeatherData();
                } else {
                    showError('LOCATION NOT FOUND');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('SEARCH FAILED. PLEASE TRY AGAIN.');
            }
        }

        // ==================== LOCATION SERVICES ====================
        async function getUserLocation() {
            updateLoadingText('DETECTING LOCATION');
            
            // Try Telegram location first
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                try {
                    const location = await tg.requestLocation();
                    if (location) {
                        userLocation = {
                            latitude: location.latitude,
                            longitude: location.longitude
                        };
                        await reverseGeocode(location.latitude, location.longitude);
                        await loadAllWeatherData();
                        return;
                    }
                } catch (error) {
                    console.log('Telegram location denied, falling back to IP');
                }
            }
            
            // Fallback to IP geolocation
            await getLocationByIP();
        }

        async function getLocationByIP() {
            try {
                updateLoadingText('GETTING LOCATION FROM IP');
                const response = await fetch('https://ipapi.co/json/');
                if (!response.ok) throw new Error('IP location failed');
                
                const data = await response.json();
                userLocation = {
                    latitude: data.latitude,
                    longitude: data.longitude
                };
                
                elements.locationName.textContent = `${data.city.toUpperCase()}, ${data.country_name.toUpperCase()}`;
                elements.elevation.textContent = `${Math.round(data.latitude * 100)} M`;
                elements.timezone.textContent = (data.timezone.split('/')[1] || data.timezone).toUpperCase();
                
                await loadAllWeatherData();
                
            } catch (error) {
                console.error('IP location error:', error);
                // Default to London
                userLocation = { latitude: 51.5074, longitude: -0.1278 };
                elements.locationName.textContent = 'LONDON, UK';
                elements.elevation.textContent = '35 M';
                elements.timezone.textContent = 'LONDON';
                
                await loadAllWeatherData();
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                
                if (data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    const country = data.address.country;
                    elements.locationName.textContent = `${city.toUpperCase()}, ${country.toUpperCase()}`;
                }
                
                // Get elevation
                const elevationResponse = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`);
                const elevationData = await elevationResponse.json();
                if (elevationData.elevation) {
                    elements.elevation.textContent = `${Math.round(elevationData.elevation[0])} M`;
                }
                
            } catch (error) {
                console.error('Reverse geocoding error:', error);
            }
        }

        // ==================== WEATHER DATA FETCHING ====================
        async function loadAllWeatherData() {
            try {
                updateLoadingText('LOADING WEATHER DATA');
                
                await Promise.all([
                    loadCurrentWeather(),
                    loadHourlyForecast()
                ]);
                
                // Hide loading screen, show app with expressive animation
                setTimeout(() => {
                    elements.loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        elements.loadingScreen.style.display = 'none';
                        elements.appContainer.style.display = 'flex';
                        setTimeout(() => {
                            elements.appContainer.style.opacity = '1';
                            // Add expressive entrance animations
                            document.querySelectorAll('.expressive-card, .expressive-module, .hour-item').forEach((el, index) => {
                                el.style.animation = `expressive-slide-in var(--animation-medium) cubic-bezier(0.2, 0, 0, 1) ${index * 100}ms both`;
                            });
                        }, 50);
                    }, 300);
                }, 800);
                
            } catch (error) {
                console.error('Weather data loading error:', error);
                showError('FAILED TO LOAD WEATHER DATA. PLEASE CHECK YOUR CONNECTION.');
            }
        }

        async function loadCurrentWeather() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.latitude}&longitude=${userLocation.longitude}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,rain,visibility,wind_speed_10m,wind_gusts_10m,cloud_cover,uv_index&daily=sunrise,sunset,uv_index_max&timezone=auto&forecast_days=2`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather API error');
                
                const data = await response.json();
                currentWeatherData = data;
                
                updateCurrentWeatherUI(data);
                updateWeatherBackground(data.current_weather.weathercode, data.current_weather.is_day);
                
            } catch (error) {
                console.error('Current weather error:', error);
                throw error;
            }
        }

        async function loadHourlyForecast() {
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${userLocation.latitude}&longitude=${userLocation.longitude}&hourly=temperature_2m,weathercode&timezone=auto&forecast_days=2`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                updateHourlyForecastUI(data);
                
            } catch (error) {
                console.error('Hourly forecast error:', error);
            }
        }

        async function loadHistoricalWeather() {
            try {
                const selectedDate = elements.historyDate.value;
                if (!selectedDate) return;
                
                const historicalUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${userLocation.latitude}&longitude=${userLocation.longitude}&start_date=${selectedDate}&end_date=${selectedDate}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=auto`;
                
                const response = await fetch(historicalUrl);
                const data = await response.json();
                
                if (data.daily) {
                    const date = new Date(selectedDate);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }).toUpperCase();
                    
                    const maxTemp = Math.round(data.daily.temperature_2m_max[0]);
                    const minTemp = Math.round(data.daily.temperature_2m_min[0]);
                    const precip = data.daily.precipitation_sum[0].toFixed(1);
                    
                    elements.historicalData.innerHTML = `
                        <div class="expressive-card">
                            <div class="expressive-label on-surface" style="margin-bottom: 24px; text-align: center;">${formattedDate}</div>
                            <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 32px;">
                                <div>
                                    <div class="weather-label on-surface">HIGH</div>
                                    <div class="expressive-headline on-surface" style="margin: 8px 0;">${maxTemp}°</div>
                                </div>
                                <div>
                                    <div class="weather-label on-surface">LOW</div>
                                    <div class="expressive-headline on-surface" style="margin: 8px 0;">${minTemp}°</div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div class="weather-label on-surface">PRECIPITATION</div>
                                <div class="expressive-title on-surface" style="margin: 12px 0;">${precip} MM</div>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Historical data error:', error);
                elements.historicalData.innerHTML = `
                    <div class="error-state">
                        <span class="material-symbols-rounded error-icon">error</span>
                        <div class="error-title on-surface">DATA UNAVAILABLE</div>
                        <div class="error-message on-surface">HISTORICAL DATA NOT AVAILABLE FOR THIS DATE</div>
                    </div>
                `;
            }
        }

        // ==================== UI UPDATES ====================
        function updateCurrentWeatherUI(data) {
            const current = data.current_weather;
            const hourly = data.hourly;
            const currentIndex = new Date().getHours();
            
            // Update temperature and description
            elements.currentTemp.textContent = Math.round(current.temperature);
            elements.weatherDescription.textContent = getWeatherDescription(current.weathercode).toUpperCase();
            
            // Update weather icon
            updateWeatherIcon(current.weathercode, current.is_day);
            
            // Update weather grid
            updateWeatherGrid(data, currentIndex);
            
            // Update UV index
            const uvIndex = Math.round(hourly.uv_index[currentIndex]);
            elements.uvIndexValue.textContent = uvIndex;
            elements.uvDescription.textContent = getUVDescription(uvIndex).toUpperCase();
            
            // Update wind gust
            elements.windGustValue.textContent = Math.round(hourly.wind_gusts_10m[currentIndex]);
        }

        function updateWeatherGrid(data, currentIndex) {
            const hourly = data.hourly;
            
            const gridItems = [
                {
                    icon: 'thermostat',
                    label: 'FEELS LIKE',
                    value: Math.round(hourly.apparent_temperature[currentIndex]) + '°',
                    unit: 'REAL FEEL'
                },
                {
                    icon: 'humidity_percentage',
                    label: 'HUMIDITY',
                    value: Math.round(hourly.relative_humidity_2m[currentIndex]) + '%',
                    unit: 'RELATIVE'
                },
                {
                    icon: 'air',
                    label: 'WIND',
                    value: Math.round(hourly.wind_speed_10m[currentIndex]),
                    unit: 'KM/H'
                },
                {
                    icon: 'rainy',
                    label: 'PRECIPITATION',
                    value: hourly.precipitation[currentIndex].toFixed(1),
                    unit: 'MM'
                },
                {
                    icon: 'visibility',
                    label: 'VISIBILITY',
                    value: (hourly.visibility[currentIndex] / 1000).toFixed(1),
                    unit: 'KM'
                },
                {
                    icon: 'cloud',
                    label: 'CLOUD COVER',
                    value: Math.round(hourly.cloud_cover[currentIndex]) + '%',
                    unit: 'SKY COVERAGE'
                }
            ];
            
            elements.weatherGrid.innerHTML = gridItems.map(item => `
                <div class="weather-item">
                    <span class="material-symbols-rounded weather-icon-small">${item.icon}</span>
                    <div class="weather-label on-surface">${item.label}</div>
                    <div class="weather-value on-surface">${item.value}</div>
                    <div class="weather-unit on-surface">${item.unit}</div>
                </div>
            `).join('');
        }

        function updateHourlyForecastUI(data) {
            const hourly = data.hourly;
            const currentHour = new Date().getHours();
            
            // Show next 8 hours
            elements.hourlyForecast.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                const hourIndex = currentHour + i;
                if (hourIndex >= hourly.time.length) break;
                
                const hourTime = new Date(hourly.time[hourIndex]);
                const hourStr = hourTime.getHours().toString().padStart(2, '0') + ':00';
                const temp = Math.round(hourly.temperature_2m[hourIndex]);
                const weatherCode = hourly.weathercode[hourIndex];
                
                const hourItem = document.createElement('div');
                hourItem.className = 'hour-item';
                hourItem.innerHTML = `
                    <div class="hour-time on-surface">${hourStr}</div>
                    <span class="material-symbols-rounded" style="font-size: 32px; color: var(--primary); margin: 8px 0;">
                        ${getWeatherIconName(weatherCode, hourTime.getHours() >= 6 && hourTime.getHours() < 18)}
                    </span>
                    <div class="hour-temp on-surface">${temp}°</div>
                `;
                
                elements.hourlyForecast.appendChild(hourItem);
            }
        }

        function updateWeatherBackground(weatherCode, isDay) {
            // Clear existing classes
            document.body.className = '';
            
            // Set new class based on weather
            if (!isDay) {
                document.body.classList.add('clear-night');
            } else if (weatherCode >= 51 && weatherCode <= 65) {
                document.body.classList.add('rainy');
            } else if (weatherCode >= 71 && weatherCode <= 77) {
                document.body.classList.add('snowy');
            } else if (weatherCode >= 95 && weatherCode <= 99) {
                document.body.classList.add('stormy');
            } else if (weatherCode === 45 || weatherCode === 48) {
                document.body.classList.add('foggy');
            } else if (weatherCode >= 1 && weatherCode <= 3) {
                document.body.classList.add('cloudy');
            } else {
                document.body.classList.add('clear-day');
            }
        }

        function updateWeatherIcon(weatherCode, isDay) {
            elements.weatherIcon.textContent = getWeatherIconName(weatherCode, isDay);
        }

        function getWeatherIconName(weatherCode, isDay) {
            if (!isDay) {
                if (weatherCode === 0) return 'clear_night';
                if (weatherCode >= 1 && weatherCode <= 3) return 'partly_cloudy_night';
                return 'cloudy';
            }
            
            if (weatherCode === 0) return 'sunny';
            if (weatherCode === 1) return 'partly_cloudy_day';
            if (weatherCode === 2 || weatherCode === 3) return 'cloudy';
            if (weatherCode >= 51 && weatherCode <= 65) return 'rainy';
            if (weatherCode >= 71 && weatherCode <= 77) return 'weather_snowy';
            if (weatherCode >= 80 && weatherCode <= 82) return 'rainy';
            if (weatherCode >= 85 && weatherCode <= 86) return 'weather_snowy';
            if (weatherCode >= 95 && weatherCode <= 99) return 'thunderstorm';
            if (weatherCode === 45 || weatherCode === 48) return 'foggy';
            return 'sunny';
        }

        function getWeatherDescription(weatherCode) {
            const descriptions = {
                0: 'Clear sky',
                1: 'Mainly clear',
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                80: 'Slight showers',
                81: 'Moderate showers',
                82: 'Violent showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with hail',
                99: 'Heavy thunderstorm with hail'
            };
            return descriptions[weatherCode] || 'Unknown';
        }

        function getUVDescription(uvIndex) {
            if (uvIndex <= 2) return 'Low';
            if (uvIndex <= 5) return 'Moderate';
            if (uvIndex <= 7) return 'High';
            if (uvIndex <= 10) return 'Very High';
            return 'Extreme';
        }

        function updateLoadingText(text) {
            if (elements.loadingText) {
                elements.loadingText.textContent = text;
            }
        }

        function showError(message) {
            elements.loadingScreen.innerHTML = `
                <div class="error-state">
                    <span class="material-symbols-rounded error-icon">error</span>
                    <div class="error-title on-gradient">OOPS!</div>
                    <div class="error-message on-gradient">${message}</div>
                    <button class="retry-button" onclick="location.reload()" style="margin-top: 24px;">TRY AGAIN</button>
                </div>
            `;
        }

        // ==================== INITIALIZE APP ====================
        document.addEventListener('DOMContentLoaded', initApp);

        // Auto-refresh every 15 minutes
        setInterval(() => {
            if (userLocation) {
                loadCurrentWeather();
            }
        }, 15 * 60 * 1000);

    </script>
</body>
</html>